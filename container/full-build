FROM debian:bookworm-slim

WORKDIR /opt/metacg

ENV DEBIAN_FRONTEND=noninteractive
ENV CMAKE_GENERATOR=Ninja

RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y gcc g++ gdb \
        cmake python3 apt-utils wget gnupg \
        qtbase5-dev git autoconf automake \
        libtool zlib1g-dev zlib1g vim unzip \
        python3-pip python3-pytest python3-pytest-cov \
        openmpi-bin openmpi-common bison flex bear \
        lsb-release wget software-properties-common \
        python3-matplotlib python3-pyqt5 ninja-build


RUN wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc && \
    add-apt-repository -y 'deb http://apt.llvm.org/bookworm/  llvm-toolchain-bookworm-18 main' && \
    add-apt-repository -y 'deb http://apt.llvm.org/bookworm/  llvm-toolchain-bookworm-18 main' && \
    apt-get update && \
    apt-get install -y libllvm18 llvm-18 llvm-18-dev llvm-18-runtime \
        clang-18 clang-tools-18 libclang-common-18-dev libclang-18-dev libclang1-18 
RUN bash -c "ln -s $(which clang-18) /usr/bin/clang" && \
    bash -c "ln -s $(which clang++-18) /usr/bin/clang++" && \
    bash -c "ln -s $(which llvm-config-18) /usr/bin/llvm-config"


RUN mkdir -p deps/install && \
      cd deps && \
      wget http://apps.fz-juelich.de/scalasca/releases/cube/4.5/dist/cubelib-4.5.tar.gz && \
      mkdir cubelib && \
      cd cubelib && \
      tar xzf ../cubelib-4.5.tar.gz && cd cubelib-4.5 && \
      ./configure --prefix=/opt/metacg/extern/install/cubelib && \
      make -j $(nproc) && \
      make install

RUN mkdir metacg

COPY ./build_submodules.sh /opt/metacg/metacg

RUN cd metacg && \
    PATH=/opt/metacg/extern/install/cubelib/bin:$PATH ./build_submodules.sh $(nproc)

COPY . /opt/metacg/metacg

RUN cd metacg && cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_INSTALL_PREFIX=/tmp/metacg \
      -DCUBE_LIB=/opt/metacg/extern/install/cubelib/lib \
      -DCUBE_INCLUDE=/opt/metacg/extern/install/cubelib/include/cubelib \
      -DEXTRAP_INCLUDE=./extern/install/extrap/include \
      -DEXTRAP_LIB=./extern/install/extrap/lib \
      -DMETACG_BUILD_PGIS=ON \
      -DMETACG_BUILD_CGCOLLECTOR=ON \
      -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON && \
    cmake --build build --parallel
