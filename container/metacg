FROM registry.git.rwth-aachen.de/tuda-sc/projects/metacg/base:latest

WORKDIR /opt/metacg

ARG extinstalldir=/opt/metacg/extern/install
ENV EXTINSTALLDIR=$extinstalldir

COPY ./build_submodules.sh /opt/metacg

RUN ./build_submodules.sh $(nproc)

COPY . /opt/metacg

RUN cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_INSTALL_PREFIX=/tmp/metacg \
      -DCUBE_LIB=$EXTINSTALLDIR/cubelib/lib \
      -DCUBE_INCLUDE=$EXTINSTALLDIR/cubelib/include/cubelib \
      -DEXTRAP_INCLUDE=$EXTINSTALLDIR/extrap/include \
      -DEXTRAP_LIB=$EXTINSTALLDIR/extrap/lib \
      -DMETACG_BUILD_PGIS=ON \
      -DMETACG_BUILD_CGCOLLECTOR=ON \
      -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON && \
    cmake --build build --parallel
