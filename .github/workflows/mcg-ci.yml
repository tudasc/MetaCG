name: MetaCG CI

on: 
  push:
  pull_request: 

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: cmake
      run: cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -B build -S .
    - name: build
      run: cmake --build build --parallel
    - name: install
      run: |
        cmake --install build --prefix install
        stat install/lib/libmetacg.so
        stat install/include/metadata/CustomMD.h
  
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Install lint tool in container
        run: |
          python3 -m pip install cmakelang
      - uses: actions/checkout@v4
      - name: CMake Lint
        run: |
          for f in $(find {cgcollector,graph,pgis} -name "CMakeLists.txt"); do cmake-format --check $f || exit 1; done ; cmake-format --check CMakeLists.txt
          for f in $(find ./cmake -type f); do cmake-format --check $f || exit 1; done

  build-container:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: "container/full-build"
          tags: metacg-devel:latest 
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false
      - name: Run MCG library tests 
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: /opt/metacg/build/graph/test/unit/libtests
      - name: Run PGIS library tests 
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: /opt/metacg/build/pgis/test/unit/pgistests
      - name: Run target collector tests 
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: |
            cd /opt/metacg/graph/test/integration/TargetCollector
            ./TestRunner.sh
      - name: Run call graph merge tests
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: |
            cd /opt/metacg/graph/test/integration/CallgraphMerge
            ./MergeTestRunner.sh
      - name: Run cgcollector tests
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: |
            cd /opt/metacg/cgcollector/test
            bash run_format_one_test.sh 
            bash run_format_two_test.sh 
      - name: Run cgvalidate tests
        uses: addnab/docker-run-action@v3
        with: 
          image: metacg-devel:latest
          run: |
            cd /opt/metacg/cgcollector/test/integration
            ./runner.sh build
